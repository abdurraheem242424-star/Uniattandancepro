
import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { 
  Users, 
  BookOpen, 
  BarChart3, 
  LogOut, 
  Menu, 
  X, 
  LayoutDashboard,
  Calendar,
  ChevronRight,
  UserCircle,
  History as HistoryIcon,
  CloudCheck,
  RefreshCw,
  CheckCircle2,
  WifiOff,
  Cloud,
  Code,
  ShieldAlert,
  ShieldCheck,
  Library,
  CloudOff,
  AlertCircle,
  Zap,
  Save as SaveIcon,
  PlusCircle,
  Plus
} from 'lucide-react';
import { storage } from './services/storage';
import { Student, Subject, AttendanceRecord, AppView, User, CorrectionRecord, ClassSettings, LectureLog } from './types';
import Login from './components/Login';
import Dashboard from './components/Dashboard';
import StudentManager from './components/StudentManager';
import SubjectManager from './components/SubjectManager';
import AttendanceSheet from './components/AttendanceSheet';
import Analytics from './components/Analytics';
import HistoryLog from './components/HistoryLog';

const App: React.FC = () => {
  const [user, setUser] = useState<User | null>(storage.getAuth());
  const [view, setView] = useState<AppView>('DASHBOARD');
  const [activeSubjectId, setActiveSubjectId] = useState<string | null>(null);
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const [saveStatus, setSaveStatus] = useState<'idle' | 'saving' | 'saved' | 'offline'>('idle');
  const [isOnline, setIsOnline] = useState(navigator.onLine);
  const [hasPendingSync, setHasPendingSync] = useState(false);
  
  // Quick Add State
  const [showAddClassModal, setShowAddClassModal] = useState(false);
  const [newClassName, setNewClassName] = useState('');
  const [newClassType, setNewClassType] = useState<'Theory' | 'Practical'>('Theory');

  const [students, setStudents] = useState<Student[]>(storage.getStudents());
  const [subjects, setSubjects] = useState<Subject[]>(storage.getSubjects());
  const [attendance, setAttendance] = useState<AttendanceRecord[]>(storage.getAttendance());
  const [history, setHistory] = useState<CorrectionRecord[]>(storage.getHistory());
  const [settings, setSettings] = useState<ClassSettings>(storage.getSettings());
  const [lectureLogs, setLectureLogs] = useState<LectureLog[]>(storage.getLectureLogs());

  // Immediate persistence helper
  const persistToLocal = useCallback(() => {
    storage.saveAttendance(attendance);
    storage.saveStudents(students);
    storage.saveSubjects(subjects);
    storage.saveHistory(history);
    storage.saveSettings(settings);
    storage.saveLectureLogs(lectureLogs);
  }, [attendance, students, subjects, history, settings, lectureLogs]);

  // Admin check: AbdurRaheem has full permission
  const isAdmin = useMemo(() => {
    if (!user) return false;
    const name = user.name.toLowerCase();
    return name.includes('abdurraheem') || name.includes('abdur raheem');
  }, [user]);

  // Monitor Network Status
  useEffect(() => {
    const handleOnline = () => {
      setIsOnline(true);
      if (hasPendingSync) triggerSync();
    };
    const handleOffline = () => setIsOnline(false);
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, [hasPendingSync]);

  const triggerSync = () => {
    setSaveStatus('saving');
    setTimeout(() => {
      setHasPendingSync(false);
      setSaveStatus('saved');
      setTimeout(() => setSaveStatus('idle'), 3000);
    }, 2000);
  };

  useEffect(() => {
    persistToLocal();
    if (isOnline) {
      setSaveStatus('saving');
      setHasPendingSync(false);
      const timer = setTimeout(() => {
        setSaveStatus('saved');
        setTimeout(() => setSaveStatus('idle'), 3000);
      }, 1500);
      return () => clearTimeout(timer);
    } else {
      setSaveStatus('offline');
      setHasPendingSync(true);
    }
  }, [attendance, students, subjects, history, settings, lectureLogs, isOnline, persistToLocal]);

  const handleLogin = (userData: User) => {
    setUser(userData);
    storage.setAuth(userData);
    setView('DASHBOARD');
  };

  const handleLogout = () => {
    setUser(null);
    setActiveSubjectId(null);
    storage.clearAuth();
  };

  const handleQuickAddClass = () => {
    if (!newClassName.trim()) return;
    const newSubject: Subject = {
      id: crypto.randomUUID(),
      name: newClassName.trim(),
      type: newClassType,
      isPracticalEnabled: newClassType === 'Practical'
    };
    const updatedSubjects = [...subjects, newSubject];
    setSubjects(updatedSubjects);
    storage.saveSubjects(updatedSubjects);
    
    setNewClassName('');
    setShowAddClassModal(false);
    
    // Automatically navigate to the newly created class
    navigateToSubject(newSubject.id);
  };

  const activeSubject = useMemo(() => 
    subjects.find(s => s.id === activeSubjectId) || null
  , [subjects, activeSubjectId]);

  const toggleSidebar = () => setIsSidebarOpen(!isSidebarOpen);

  const handleUpdateAttendance = (newRecords: AttendanceRecord[], corrections?: CorrectionRecord[]) => {
    if (!isAdmin) {
      alert("Permission denied. Only AbdurRaheem can mark attendance.");
      return;
    }
    setAttendance(newRecords);
    if (corrections && corrections.length > 0) {
      setHistory(prev => [...corrections, ...prev]);
    }
  };

  const handleUpdateLectureLogs = (newLogs: LectureLog[]) => {
    if (!isAdmin) return;
    setLectureLogs(newLogs);
  };

  const handleUpdateSubjects = (updatedSubjects: Subject[], deletedSubjectId?: string) => {
    if (!isAdmin) return;
    setSubjects(updatedSubjects);
    if (deletedSubjectId) {
      setAttendance(prev => prev.filter(record => record.subjectId !== deletedSubjectId));
      setHistory(prev => prev.filter(record => record.subjectId !== deletedSubjectId));
      setLectureLogs(prev => prev.filter(log => log.subjectId !== deletedSubjectId));
    }
  };

  const handleUpdateSettings = (newSettings: ClassSettings) => {
    if (!isAdmin) return;
    setSettings(newSettings);
  };

  if (!user) {
    return <Login onLogin={handleLogin} />;
  }

  const navigateToSubject = (subjectId: string) => {
    setActiveSubjectId(subjectId);
    setView('ATTENDANCE_SHEET');
    setIsSidebarOpen(false);
  };

  const SidebarItem: React.FC<{ 
    icon: React.ReactNode; 
    label: string; 
    active: boolean; 
    onClick: () => void 
  }> = ({ icon, label, active, onClick }) => (
    <button
      onClick={onClick}
      className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${
        active 
          ? 'bg-indigo-600 text-white shadow-md' 
          : 'text-slate-600 hover:bg-slate-100'
      }`}
    >
      {icon}
      <span className="font-medium truncate">{label}</span>
      {active && <ChevronRight className="ml-auto w-4 h-4 shrink-0" />}
    </button>
  );

  const SyncStatusIndicator = ({ className = "" }: { className?: string }) => {
    if (!isOnline) {
      return (
        <div className={`flex items-center gap-2 px-3 py-1.5 rounded-full border transition-all ${
          hasPendingSync ? 'bg-amber-50 border-amber-200 text-amber-700' : 'bg-slate-100 border-slate-200 text-slate-500'
        } ${className}`}>
          {hasPendingSync ? <SaveIcon size={14} className="animate-pulse" /> : <WifiOff size={14} />}
          <span className="text-[10px] font-black uppercase tracking-tight">
            {hasPendingSync ? 'Local-Only' : 'Offline'}
          </span>
        </div>
      );
    }
    return (
      <div className={`flex items-center gap-2 px-3 py-1.5 rounded-full border border-emerald-100 bg-emerald-50 text-emerald-700 transition-all ${className}`}>
        <CloudCheck size={14} />
        <span className="text-[10px] font-black uppercase tracking-tight">Cloud Active</span>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col md:flex-row">
      {/* Quick Add Class Modal */}
      {showAddClassModal && (
        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
          <div className="bg-white w-full max-w-md rounded-3xl p-8 shadow-2xl animate-in zoom-in-95 duration-200">
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-xl font-black text-slate-800 uppercase tracking-tight">Add New Class Register</h3>
              <button onClick={() => setShowAddClassModal(false)} className="text-slate-400 hover:text-slate-600"><X /></button>
            </div>
            <div className="space-y-5">
              <div className="space-y-2">
                <label className="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1">Class/Subject Name</label>
                <input 
                  autoFocus
                  type="text" 
                  value={newClassName}
                  onChange={(e) => setNewClassName(e.target.value)}
                  placeholder="e.g. Environmental Science"
                  className="w-full px-4 py-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 font-bold text-slate-700"
                />
              </div>
              <div className="space-y-2">
                <label className="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1">Type</label>
                <div className="flex bg-slate-50 p-1 rounded-xl border">
                  <button 
                    onClick={() => setNewClassType('Theory')}
                    className={`flex-1 py-2 text-xs font-black uppercase rounded-lg transition-all ${newClassType === 'Theory' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`}
                  >
                    Theory
                  </button>
                  <button 
                    onClick={() => setNewClassType('Practical')}
                    className={`flex-1 py-2 text-xs font-black uppercase rounded-lg transition-all ${newClassType === 'Practical' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`}
                  >
                    Practical
                  </button>
                </div>
              </div>
              <div className="pt-4">
                <button 
                  onClick={handleQuickAddClass}
                  className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-4 rounded-2xl font-black shadow-lg shadow-indigo-100 transition-all active:scale-95"
                >
                  Create & Open Register
                </button>
                <p className="text-center text-[10px] text-slate-400 mt-4 font-bold uppercase tracking-widest">
                  Students will be automatically imported
                </p>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Mobile Header */}
      <div className="md:hidden bg-white border-b px-4 py-3 flex items-center justify-between sticky top-0 z-50">
        <div className="flex items-center gap-2">
          <BookOpen className="text-indigo-600 w-6 h-6" />
          <h1 className="text-lg font-bold tracking-tight">Agri 301</h1>
        </div>
        <div className="flex items-center gap-2">
          <SyncStatusIndicator />
          <button onClick={toggleSidebar} className="p-2 text-slate-600 hover:bg-slate-50 rounded-lg">
            {isSidebarOpen ? <X /> : <Menu />}
          </button>
        </div>
      </div>

      {isSidebarOpen && (
        <div className="fixed inset-0 bg-black/50 z-40 md:hidden" onClick={() => setIsSidebarOpen(false)} />
      )}

      {/* Desktop Sidebar */}
      <aside className={`
        fixed md:static inset-y-0 left-0 w-72 bg-white border-r z-50 transition-transform duration-300 transform
        ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}
        flex flex-col
      `}>
        <div className="p-6 hidden md:flex flex-col gap-1 border-b">
          <div className="flex items-center gap-3">
            <BookOpen className="text-indigo-600 w-8 h-8" />
            <h1 className="text-2xl font-black tracking-tight">UniAttend</h1>
          </div>
          <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">BSC (hons) Agriculture 301</p>
        </div>

        <div className="flex-1 overflow-y-auto p-4 space-y-2">
          <p className="text-xs font-semibold text-slate-400 uppercase px-4 pb-2 pt-4">Main</p>
          <SidebarItem 
            icon={<LayoutDashboard size={20} />} 
            label="Dashboard" 
            active={view === 'DASHBOARD'} 
            onClick={() => { setView('DASHBOARD'); setIsSidebarOpen(false); }} 
          />
          
          {isAdmin && (
            <>
              <SidebarItem 
                icon={<Users size={20} />} 
                label="Class List" 
                active={view === 'STUDENT_LIST'} 
                onClick={() => { setView('STUDENT_LIST'); setIsSidebarOpen(false); }} 
              />
              <SidebarItem 
                icon={<Library size={20} />} 
                label="Subjects" 
                active={view === 'SUBJECT_LIST'} 
                onClick={() => { setView('SUBJECT_LIST'); setIsSidebarOpen(false); }} 
              />
            </>
          )}

          <SidebarItem 
            icon={<HistoryIcon size={20} />} 
            label="History" 
            active={view === 'HISTORY'} 
            onClick={() => { setView('HISTORY'); setIsSidebarOpen(false); }} 
          />
          <SidebarItem 
            icon={<BarChart3 size={20} />} 
            label="Analytics" 
            active={view === 'ANALYTICS'} 
            onClick={() => { setView('ANALYTICS'); setIsSidebarOpen(false); }} 
          />

          <div className="flex items-center justify-between px-4 pb-2 pt-6">
            <p className="text-xs font-semibold text-slate-400 uppercase">Registers</p>
            {isAdmin && (
              <button 
                onClick={() => setShowAddClassModal(true)}
                className="p-1 hover:bg-indigo-50 text-indigo-600 rounded-md transition-colors"
                title="Add New Class"
              >
                <Plus size={16} />
              </button>
            )}
          </div>
          <div className="space-y-1">
            {subjects.map(subject => (
              <SidebarItem 
                key={subject.id}
                icon={<Calendar size={20} />} 
                label={subject.name} 
                active={view === 'ATTENDANCE_SHEET' && activeSubjectId === subject.id} 
                onClick={() => navigateToSubject(subject.id)} 
              />
            ))}
          </div>
        </div>

        {/* Sidebar Footer */}
        <div className="p-4 border-t space-y-4">
          <div className="flex items-center gap-3 px-2">
            <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold shadow-sm shrink-0 ${
              isAdmin ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-600'
            }`}>
              {isAdmin ? <ShieldCheck size={20} /> : user.name.charAt(0)}
            </div>
            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-1.5">
                <p className="text-sm font-bold text-slate-800 truncate">{user.name.split(' (')[0]}</p>
                {isAdmin && <span className="px-1 py-0.5 rounded bg-indigo-100 text-indigo-700 text-[8px] font-black uppercase">Admin</span>}
              </div>
              <p className="text-[10px] text-slate-500 truncate">{user.email}</p>
            </div>
          </div>
          <button 
            onClick={handleLogout}
            className="w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-red-600 hover:bg-red-50 transition-colors"
          >
            <LogOut size={18} />
            <span className="text-sm font-bold">Sign Out</span>
          </button>
        </div>
      </aside>

      <main className="flex-1 flex flex-col min-w-0 h-screen overflow-y-auto">
        <div className="p-4 md:p-8">
          {view === 'DASHBOARD' && (
            <Dashboard 
              subjects={subjects} 
              attendance={attendance} 
              studentsCount={students.length}
              onNavigate={navigateToSubject}
            />
          )}
          {view === 'STUDENT_LIST' && isAdmin && <StudentManager students={students} onUpdate={setStudents} />}
          {view === 'SUBJECT_LIST' && isAdmin && <SubjectManager subjects={subjects} onUpdate={handleUpdateSubjects} />}
          {view === 'ATTENDANCE_SHEET' && activeSubject && (
            <AttendanceSheet 
              subject={activeSubject}
              students={students}
              attendance={attendance}
              lectureLogs={lectureLogs}
              onUpdateAttendance={handleUpdateAttendance}
              onUpdateLectureLogs={handleUpdateLectureLogs}
              currentUser={user}
              readOnly={!isAdmin}
              settings={settings}
              onUpdateSettings={handleUpdateSettings}
            />
          )}
          {view === 'ANALYTICS' && <Analytics students={students} attendance={attendance} subjects={subjects} />}
          {view === 'HISTORY' && (
            <HistoryLog 
              history={history}
              onClear={() => {
                if (!isAdmin) { alert("Only Admin can clear logs."); return; }
                if (window.confirm("Clear history?")) setHistory([]);
              }}
            />
          )}
        </div>
      </main>
    </div>
  );
};

export default App;
